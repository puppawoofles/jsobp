<!DOCTYPE html>
<html>
    <head><title>(pnxen) Encounters and other encounter accessories</title></head>
    <body>
		<import file="data_frames/phoenix/unit-gen.html" as="UNITS"></import>


        <!--
            COMMON BATTLEFIELD SHAPES GO HERE
        -->
       
        <battlefield-gen name="basic_cross">
            <geo battlefield-fn="BattlefieldGen.generateRect" width="3" height="3"></geo>
            <forBlocks labels="A1 A3 C1 C3">
                <copy disabled="true"></copy>
            </forBlocks>
        </battlefield-gen>

        <battlefield-gen name="herd_crossing" base="${SELF}.basic_cross">
            <forBlocks labels="A2 C2">
                <copy team="player"></copy>
            </forBlocks>
            <forBlocks labels="B1 B2 B3">
                <copy team="enemy"></copy>
            </forBlocks>
        </battlefield-gen>

        <!--
            EVENT STATES GO HERE
        -->
        <event-blueprint name="hunt_for_food" label="Hunt for Food">
            <state type="vignette" name="start" start="true">
                <flavor>
                    <p>You're here to get some food for your group of humans.</p>
                    <p>Kill the antelope as they cross to get some food!</p>
                </flavor>
                <choice result="1" label="Can do!"></choice>
                <event-result choice="1" next-state="fight"></event-result>	
            </state>
            <state type="encounter" name="fight">
                <encounter base="${SELF}.base">
                    <battlefield base="${SELF}.herd_crossing">
                        <!-- TODO: Make this work. -->
                        <forCells labels="B3.A3 B3.B3 B3.C3">
                            <add tag="spawn"></add>
                        </forCells>
                        <forCells labels="A2.A1 A2.A2 A2.A3 C2.C1 C2.C2 C2.C3 B1.A1 B1.B1 B1.C1">
                            <add tag="escape"></add>
                        </forCells>
                    </battlefield>
                    <endCondition end-fn="EncounterRules.Endless" type="win">
                        You're stuck here forever!  Go go dev.
                    </endCondition>
                    <installHandlers>
                        <!-- TODO: Make this work with the spawn tags. -->
                        <handler handler="HuntForFoodEncounter.SpawnDeer" event-types="Volley:before" spawn-count="20" spawn-selector="[tag~='spawn']" location-filter="HuntForFoodEncounter.SpawnLocationFilter">
                            <unit-gen base="${UNITS}.deer">
                                <copy team="enemy" preferred-locations="B1.A1 B1.B1 B1.C1"></copy>
                                <add tag="deer"></add>
                                <forMoveSlots selector="[tag=basic]">
                                    <copyDest cooldown-duration="12"></copyDest>
                                </forMoveSlots>
                            </unit-gen>
                        </handler>
                </encounter>
                <event-result choice="victory" victory="true"></event-result>
                <event-result choice="wipe" victory="false"></event-result>
                <event-result choice="giveUp" victory="false"></event-result>
            </state>
        </event-blueprint>






        <!--
            ENCOUNTER GENERATION GOES HERE
        -->

        <encounter-gen name="base">
            <!-- Update initiative order if needed. -->
            <ifAllDef keys="playersSurprised">
                <copyDest initiative-order="enemy player neutral"></copyDest>
            </ifAllDef>

            <!-- Set up retreat options. -->
            <ifAllDef keys="retreatPossible">
                <bonusCards>
                    <!-- Retreat card goes here. -->
                </bonusCards>
            </ifAllDef>

            <!-- Set up handlers -->
            <installHandlers>
                <!-- Encounter Structure -->
                <handler handler="EncounterRules.Round" event-types="Round"></handler>
                <handler handler="RoundRules.PlayRound" event-types="PlayRound"></handler>
                <handler handler="RoundRules.Volley" event-types="Volley"></handler>
                <handler handler="RoundRules.TickCooldowns" event-types="Volley:after"></handler>
                <handler handler="RoundRules.UseMove" event-types="UseMove"></handler>
                <handler handler="RoundRules.BlockActivation" event-types="BlockActivation"></handler>
                <handler handler="RoundRules.ActivateGroup" event-types="ActivateGroup"></handler>
                <handler handler="UnitRules.UseAbility" event-types="UseAbility"></handler>

                <!-- Combat effects -->
                <handler handler="UnitRules.Attack" event-types="Attack"></handler>
                <handler handler="UnitRules.TakeDamage" event-types="TakeDamage"></handler>
                <handler handler="UnitRules.UnitDeath" event-types="UnitDeath"></handler>
                <handler handler="UnitRules.UnitRetreat" event-types="UnitRetreat"></handler>
                <handler handler="UnitRules.UnitMoveToward" event-types="UnitMoveToward"></handler>
                <handler handler="UnitRules.ShiftUnit" event-types="ShiftUnit"></handler>
                <handler handler="UnitRules.PushUnit" event-types="PushUnit"></handler>
                <handler handler="UnitRules.UnitCollision" event-types="UnitCollision"></handler>
                <handler handler="UnitRules.ApplyStatus" event-types="ApplyStatus" TODO></handler>
                <handler handler="UnitRules.RemoveStatus" event-types="RemoveStatus" TODO></handler>

                <!-- Handlers for card behavior -->
                <handler handler="CardRules.DrawCard" event-types="DrawCard"></handler>
                <handler handler="CardRules.RefillHand" event-types="RefillHand"></handler>
                <handler handler="CardRules.DiscardCards" event-types="DiscardCards"></handler>
                <handler handler="CardRules.DiscardSingleCard" event-types="DiscardSingleCard"></handler>
                <handler handler="CardRules.ShuffleDiscard" event-types="ShuffleDiscard"></handler>
                <handler handler="CardRules.PlayCard" event-types="PlayCard" TODO></handler>
            
                <!-- Handlers for structural UI effects-->
                <handler label="EndOfCombat" handler="UiTreatments.OnAfterUiEffect" event-types="Encounter:after" skip-log="true">
                    <ui-effect type="delay" delay="1000"></ui-effect>
                    <ui-effect type="banner" content-fn="EncounterRules.EndOfEncounterBanner"></ui-effect>
                </handler>

                <!-- Handlers for UI Effects -->
                <handler label="VolleyDelay" handler="UiTreatments.OnAfterUiEffect" event-types="Volley:after" skip-log="true">
                    <ui-effect type="delay" delay-fn="VolleyCounter.VolleySpeed" delays="500 100 0"></ui-effect>
                </handler> 
                <handler label="DamageNumbers" handler="UiTreatments.OnAfterUiEffect" event-types="TakeDamage:after" target-fn="UnitRules.TakeDamageUnit" skip-log="true">
                    <ui-effect type="delay" delay-fn="VolleyCounter.VolleySpeed" delays="0 0 NaN"></ui-effect>
                    <ui-effect type="blink" blink-color="red"></ui-effect>
                    <ui-effect type="text" color="red" shadow="black" text-fn="UnitRules.TakeDamageAmount" start-transform="translateY(0px)" end-transform="translateY(-50px)"></ui-effect>
                </handler>
                <handler label="DeathIcon" handler="UiTreatments.OnAfterUiEffect" event-types="UnitDeath:before" target-fn="UnitRules.UnitDeathUnit" skip-log="true">
                    <ui-effect type="wub" icon="☠️"></ui-effect>
                </handler>
                <handler label="RetreatIcon" handler="UiTreatments.OnAfterUiEffect" event-types="UnitRetreat:before" target-fn="UnitRules.UnitDeathUnit" skip-log="true">
                    <ui-effect type="wub" icon="🏳️"></ui-effect>
                </handler>
                <handler label="CollisionIcon" handler="UiTreatments.OnAfterUiEffect" event-types="UnitCollision:after" skip-log="true">
                    <ui-effect type="wub" icon="💥" target-fn="UiTreatments.TargetsFromParams" target-param="firstUnit secondUnit"></ui-effect>
                </handler>
                <handler label="PushWhoosh" handler="UiTreatments.OnAfterUiEffect" event-types="ShiftUnit:before" skip-log="true">
                    <ui-effect type="wub" icon="💨" target-fn="UiTreatments.TargetsFromParams" target-param="unit" filter-fn="UnitRules.ShiftFromPush"></ui-effect>
                </handler>
                <handler label="ComboTreatments" handler="UiTreatments.OnAfterUiEffect" event-types="ActivateGroup:before" skip-log="true">
                    <ui-effect type="blink" filter-fn="RoundRules.ActivateGroupHasCombo" target-fn="RoundRules.ActivateGroupUnits" blink-color="yellow"></ui-effect>
                    <ui-effect type="delay" filter-fn="RoundRules.ActivateGroupHasCombo" delay-fn="VolleyCounter.VolleySpeed" delays="1500 1500 200"></ui-effect>
                </handler>
                <handler label="AbilityName" handler="UiTreatments.OnAfterUiEffect" event-types="UseAbility:before" skip-log="true">
                    <ui-effect type="text" color="white" shadow="black" text-fn="UnitRules.UseAbilityName" target-fn="UnitRules.UseAbilityUnit"></ui-effect>
                    <ui-effect type="delay" delay-fn="VolleyCounter.VolleySpeed" delays="50 0 NaN"></ui-effect>
                </handler>

                <!-- Handlers for updating functional UI -->
                <handler label="ActionButtonVolley" handler="EncounterRules.RemoveStopBeforeRound" event-types="Round:before"></handler>
                <handler label="ActionButtonVolley" handler="EncounterRules.BlockAfterVolleyIfPaused" event-types="Volley:after"></handler>	
                <handler label="UnitPreAbility" handler="Unit.BeforeUseAbility" event-types="UseAbility:before"></handler>
                <handler label="UnitPostAbility" handler="Unit.AfterUseAbility" event-types="UseAbility:after"></handler>
                <handler label="VolleyTrackerRound" handler="VolleyCounter.AfterPlayRound" event-types="PlayRound:after"></handler>
                <handler label="VolleyTrackerVolley" handler="VolleyCounter.AfterVolley" event-types="Volley:after"></handler>
                <handler label="VolleyTrackerVolley" handler="VolleyCounter.BeforeVolley" event-types="Volley:before"></handler>

            </installHandlers>
        </encounter-gen>

        <encounter-gen name="default" base="${SELF}.base">
            <!-- Default encounter-end conditions. -->
            <endCondition end-fn="EncounterRules.DefaultWin" type="win">
                Defeat all enemies to win!
            </endCondition>

            <endCondition end-fn="EncounterRules.DefaultWipe" type"lose">
                You lose if all your units die!
            </endCondition>
        </encounter-gen>








    </body>
</html>